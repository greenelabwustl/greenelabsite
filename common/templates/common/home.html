{% extends "common/base.html" %}
{% load staticfiles %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<link href="{% static 'common/css/pace-theme-center-circle.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="grid-x">
    <div class="cell medium-12 large-12">
        <div class="grid-y grid-frame align-center-middle primary main-block" style="height:100vh;background:#BFD8D2;overflow-x:hidden;">
            <div class="grid-container fluid canvas-container grid-frame"></div>
            <div id="rotator" style="height:100px;width:100px"></div>
            <div style="position:absolute; z-index:100; top:1%; right:5%;">
                <p class="help" style="font-size:3vmin;">hover over a region to see its label</p>
            </div>
            <div style="position:absolute; z-index:100; bottom:5%; right:5%;">
                <h4 class="region-display"></h4>
            </div>
            <div style="position:absolute; z-index:100; bottom:5%; left:5%;">
                <p class="title-text" style="font-size:8vmin;">greene lab</p>
                <a id="interact" class="button custom" style="font-size:3vmin;">interact</a>
            </div>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center primary" style="height:100vh;background:#F4F4F4;">
            <h1><a style="color: black;" href="{% url 'common:people' %}">lab members</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#DCB239;">
            <h1><a style="color: black;" href="{% url 'common:research' %}">research</a></h1>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#FEDCD2;">
            <h1><a style="color: black;" href="{% url 'common:publications' %}">publications</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#85DCB0;">
            <h1><a style="color: black;" href="{% url 'common:participate' %}">participate</a></h1>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#DF744A;">
            <h1><a style="color: black;" href="{% url 'common:datasoftware' %}">data/software</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#77C9D4;">
            <h1><a style="color: black;" href="{% url 'common:directions' %}">directions</a></h1>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#4484CE;">
            <h1><a style="color: black;" href="https://dosenbachlab.wustl.edu/wiki/">wiki</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#DCC7AA;">
            <h1><a style="color: black;" href="{% url 'common:contact' %}">contact</a></h1>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Javascript -->
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="{% static 'common/js/foundation.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js"></script>
<script src="{% static 'common/js/OrbitControls.js' %}"></script>
<script src="https://cdn.rawgit.com/greenelabwustl/greenelabsite/updatedsurfaces/common/static/common/js/MSC06_networks_32k.js"></script>
<script src="https://cdn.rawgit.com/greenelabwustl/greenelabsite/greene/common/static/common/js/MSC06.L.pial.32k.js"></script>
<script src="https://cdn.rawgit.com/greenelabwustl/greenelabsite/greene/common/static/common/js/MSC06.R.pial.32k.js"></script>
<script>
// Hide ui elements
$('.region-display').hide();
$('.help').hide();

// Setup renderer
var renderer = new THREE.WebGLRenderer();
renderer.setSize($('.main-block').width(),$('.main-block').height());
$('.main-block').append(renderer.domElement);

// Setup scene
var scene = new THREE.Scene();
scene.background = new THREE.Color(0xBFD8D2);

// Setup lighting
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,300,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(300,0,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,0,300);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,-300,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(-300,0,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,0,-300);
scene.add(light);

// Setup camera
var w = 8;
var h = 7;
var camera = new THREE.OrthographicCamera($('.main-block').width()/-w,$('.main-block').width()/w,$('.main-block').height()/h,$('.main-block').height()/-h,0.1,1000 );
camera.position.z = 170;
var controls = new THREE.OrbitControls(camera);
controls.dispose(); // disable controls
controls.autoRotate = true;
controls.enablePan = false;
controls.enableKeys = false;

// Setup raycaster
var raycaster = new THREE.Raycaster();

// Track mouse
var mouse = new THREE.Vector2();
function onMouseMove(event) {
    mouse.x = (event.clientX/$('.main-block').width())*2-1;
    mouse.y = -(event.clientY/$('.main-block').height())*2+1;
}
window.addEventListener('mousemove',onMouseMove,false);

// Define network names
var networks = [
    'Default',
    'Visual',
    'Fronto-parietal',
    'Medial Visual',
    'Dorsal Attention',
    'Premotor',
    'Ventral Attention',
    'Salience',
    'Cingulo-opercular',
    'Hand Somatomotor',
    'Mouth Somatomotor',
    'Auditory',
    'Medial Temporal Lobe',
    'Posterior Medial Temporal Lobe',
    'Parietal Memory',
    'Context',
    'Foot Somatomotor',
    'Occipital Temporal Parietal',
    'Unknown',
    'No Label',
    'None'
]

// Make pial geometry for each hemisphere
var left_pial = make_pial_geometry(lhdata,'L');
var right_pial = make_pial_geometry(rhdata,'R');
left_pial.translate(20,0,0);
right_pial.translate(20,0,0);
material = new THREE.MeshLambertMaterial({
    vertexColors: THREE.VertexColors
});
scene.add(new THREE.Mesh(left_pial,material));
scene.add(new THREE.Mesh(right_pial,material));

function render_loop() {
    // Render loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        render();
    }
    animate();
}

// Render function
var previousnet = '';
function render() {
    raycaster.setFromCamera(mouse,camera);
    var intersects = raycaster.intersectObjects(scene.children);
    if (state == 1) {
        if ( intersects.length === 0 ) {
            // if not already no network
            if (previousnet !== 'None') {
                // set color to no network
                for (let i = 0; i < left_pial.faces.length; i++) {
                    for (let c = 0; c < 3; c++) {
                        left_pial.faces[i].vertexColors[c].copy(left_pial.faces[i].vtxcolor['None'][c]);
                        right_pial.faces[i].vertexColors[c].copy(right_pial.faces[i].vtxcolor['None'][c]);
                    }
                }
                // set display to blank
                $('.region-display').html('');
                // update colors
                left_pial.colorsNeedUpdate = true;
                right_pial.colorsNeedUpdate = true;
                //set previousnet to none
                previousnet = 'None';
            }            
        }
        else { // user hover over network
            // get selected network
            var label = intersects[0].face.network[0];
            // if not already the same network
            if (previousnet !== label) {
                // set color to selected network
                for (let i = 0; i < left_pial.faces.length; i++) {
                    for (let c = 0; c < 3; c++) {
                        left_pial.faces[i].vertexColors[c].copy(left_pial.faces[i].vtxcolor[label][c]);
                        right_pial.faces[i].vertexColors[c].copy(right_pial.faces[i].vtxcolor[label][c]);
                    }
                }
                // set display to blank
                $('.region-display').html(label);
                // update colors
                left_pial.colorsNeedUpdate = true;
                right_pial.colorsNeedUpdate = true;
                //set previousnet to label
                previousnet = label;
            }
        }
    }
    // render scene
    renderer.render(scene,camera);
}

// resize renderer and camera on window resize
$(window).resize(function() {
    camera.left = $('.main-block').width()/-w;
    camera.right = $('.main-block').width()/w;
    camera.top = $('.main-block').height()/h;
    camera.bottom = $('.main-block').height()/-h;
    camera.updateProjectionMatrix();
    renderer.setSize($('.main-block').width(),$('.main-block').height());
});

render_loop();

// Draw pial surface geometry
function make_pial_geometry(pialdata,hemi) {
    // Setup Geometry
    var geometry = new THREE.Geometry();
    for (var i = 0; i < pialdata.vertices.length; i++) {
        // Define vertices
        geometry.vertices.push(
            new THREE.Vector3(
                pialdata.vertices[i][1],
                pialdata.vertices[i][2],
                pialdata.vertices[i][0]
            )
        );
    }
    for (let i = 0; i < pialdata.faces.length; i++) {
        // define color and network name
        var color = new Array(3);
        var name = new Array(3);
        
    	// get color for each vertex
        for (let n = 0; n < 3; n++) {
        	color[n] = colortable[hemi][pialdata.faces[i][n]]["Color"];
            if (color[n] === null) { color[n] = [0.25,0.25,0.25]; }
            name[n] = colortable[hemi][pialdata.faces[i][n]]["Network"];
            if (name[n] === null) { name[n] = 'No Label' }
        }
        
        // remap vertices to be in THREE.js order
        color = remap(color);
        name = remap(name);

        // Define face and initialize to none color
        geometry.faces.push(
            new THREE.Face3(
                pialdata.faces[i][1],
                pialdata.faces[i][2],
                pialdata.faces[i][0],
                null,
                [
                    new THREE.Color(0.5,0.5,0.5),
                    new THREE.Color(0.5,0.5,0.5),
                    new THREE.Color(0.5,0.5,0.5)
                ]
            )
        )

        // set vtxcolor object
        geometry.faces[i].vtxcolor = {};
        // Set colors for each network
        for (let n = 0; n < networks.length; n++) {
            // set color array for network
            geometry.faces[i].vtxcolor[networks[n]] = new Array(3);
            for (let v = 0; v < 3; v++) {
                // vertex is part of network                
                if (networks[n] === name[v]) {
                    // assign it the correct color
                    geometry.faces[i].vtxcolor[networks[n]][v] = new THREE.Color(color[v][0],color[v][1],color[v][2]);
                }
                else { // vertex is not part of network
                    // assign in the default gray color
                    geometry.faces[i].vtxcolor[networks[n]][v] = new THREE.Color(0.5,0.5,0.5);
                }  
            }
        }
        
        // set network name
        geometry.faces[i].network = name;
    }
    // compute vertex and face normals
    geometry.computeFaceNormals();
    geometry.computeVertexNormals();
    
    // return geometry
    return geometry;
}

// three.js array vertex order
function remap(array) {
    two = array[0];
    one = array[2];
    zero = array[1];
    return [zero,one,two];
}

// enable/controls on click
var state = 0;
$("#interact").click(function(){
    if (state == 0) {
        $("#interact").html('back');
        $('.title-text').hide();
        $('.help').show();
        $('.region-display').show();
        controls.autoRotate = false;
        controls.startagain();
        state = 1;
    }
    else if (state == 1) {
        $("#interact").html('interact');
        $('.title-text').show();
        $('.help').hide();
        $('.region-display').hide();
        controls.dispose();
        state = 0;
    }
});
</script>
{% endblock %}
